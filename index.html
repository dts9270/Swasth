<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission 1 Lakh - Contact Picker</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* BASIC STYLES */
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f4f8; }
    
    /* LOADER */
    #loaderOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #0057b7; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* HEADER */
    .header { background: linear-gradient(90deg, #0052d4, #4364f7, #6fb1fc); padding: 15px; text-align: center; color: white; }
    
    /* TABS */
    .tab-btns { display: flex; justify-content: center; gap: 5px; background: #fff; padding: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .tab-btns button { padding: 10px 10px; border: none; background: #e0e0e0; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.3s; flex: 1; }
    .tab-btns button.active-btn { background: #0057b7; color: white; }

    /* CONTAINER */
    .container { width: 95%; max-width: 950px; margin: 15px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 500px; }
    .tab { display: none; }
    .active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* FORMS */
    label { display: block; margin-top: 10px; font-weight: 600; color: #444; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    .action-btn { margin-top: 20px; background: #28a745; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }

    /* BMI BOX */
    .bmi-result { margin-top: 10px; padding: 10px; background: #e9ecef; border-left: 5px solid #333; font-weight: bold; }

    /* TABLE */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { background: #0057b7; color: white; padding: 10px; text-align: left; }
    td { border-bottom: 1px solid #ddd; padding: 8px; vertical-align: middle; }
    
    /* STATUS COLORS */
    .status-select { padding: 8px; font-weight: bold; border-radius: 4px; border: 1px solid #ccc; width: 100%; margin-bottom: 5px; }
    
    /* ROW COLORS */
    tr.row-done { background-color: #e8f5e9; }      /* Greenish */
    tr.row-planning { background-color: #fff3cd; }  /* Yellowish */
    tr.row-pending { background-color: #fff; }      /* White */

    /* CONTACT ICONS */
    .btn-icon { text-decoration: none; font-size: 22px; margin-right: 15px; display: inline-block; transition: 0.2s; }
    .btn-icon:hover { transform: scale(1.2); }

    /* CONTACT PICKER BTN */
    .pick-btn { background: #0057b7; color: white; border: none; border-radius: 5px; width: 50px; cursor: pointer; font-size: 20px; margin-top: 5px; }

  </style>
</head>

<body>

  <div id="loaderOverlay"><div class="spinner"></div><p>Please Wait...</p></div>

  <div class="header">
    <h2>üáÆüá≥ Mission 1 Lakh (Auto Contact)</h2>
  </div>

  <div class="tab-btns">
    <button onclick="openTab('tab1', this)" class="active-btn">1. ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä & BMI</button>
    <button onclick="openTab('tab2', this)">2. ‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó & ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï</button>
    <button onclick="openTab('tab3', this)">3. ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</button>
    <button onclick="openTab('tab4', this)">4. ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</button>
  </div>

  <div id="tab1" class="tab active container">
    <h3>üìù ‡§®‡§µ‡•Ä‡§® ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä</h3>
    
    <label>‡§™‡•Ç‡§∞‡•ç‡§£ ‡§®‡§æ‡§µ</label>
    <input type="text" id="inpName" placeholder="‡§®‡§æ‡§µ ‡§Ü‡§™‡•ã‡§Ü‡§™ ‡§Ø‡•á‡§à‡§≤ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡§æ"/>

    <div style="display:flex; gap:10px;">
      <div style="flex:1">
          <label>‡§µ‡§Ø</label>
          <input type="number" id="inpAge" placeholder="30"/>
      </div>
      
      <div style="flex:1.5">
          <label>‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤</label>
          <div style="display:flex; gap:5px;">
            <input type="tel" id="inpMobile" placeholder="98XXXXXXXX" style="width:100%;"/>
            <button onclick="pickContact()" class="pick-btn" title="Select Contact">üìí</button>
          </div>
      </div>
    </div>
    
    <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-top:15px; border:1px solid #ddd;">
      <h4 style="margin:0 0 10px 0; color:#0057b7;">‚öñÔ∏è BMI ‡§ï‡•Ö‡§≤‡•ç‡§ï‡•ç‡§Ø‡•Å‡§≤‡•á‡§ü‡§∞</h4>
      <div style="display:flex; gap:10px;">
        <div style="flex:1">
          <label>‡§µ‡§ú‡§® (KG)</label>
          <input type="number" id="inpWeight" placeholder="Ex: 70" oninput="calcBMI()"/>
        </div>
        <div style="flex:1">
          <label>‡§â‡§Ç‡§ö‡•Ä (CM)</label>
          <input type="number" id="inpHeight" placeholder="Ex: 170" oninput="calcBMI()"/>
        </div>
      </div>
      <div id="bmiDisplay" class="bmi-result">BMI: 0.0</div>
    </div>

    <button class="action-btn" onclick="savePerson()">üíæ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ</button>
  </div>

  <div id="tab2" class="tab container">
    <h3>üóìÔ∏è ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏, ‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó ‡§Ü‡§£‡§ø ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï</h3>
    <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="üîç ‡§®‡§æ‡§µ‡§æ‡§®‡•á ‡§∂‡•ã‡§ß‡§æ..." style="padding:10px; width:100%; margin-bottom:15px; border: 2px solid #0057b7;">
    
    <div style="overflow-x:auto;">
      <table id="dataTable">
        <thead>
          <tr>
            <th>‡§®‡§æ‡§µ / BMI</th>
            <th style="width: 28%;">‡§∏‡•ç‡§ü‡•á‡§ü‡§∏ & ‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó</th>
            <th>‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï (Call/WA)</th>
            <th>Del</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab3" class="tab container">
    <h3>üìÇ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ö‡§™‡§≤‡•ã‡§°</h3>
    <input type="file" id="reportFile" style="border: 2px dashed #0057b7; padding: 20px; width:100%;"/>
    <button class="action-btn" style="background:#17a2b8;" onclick="uploadReport()">Upload Report</button>
  </div>

  <div id="tab4" class="tab container">
    <h3>üìä ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§Ö‡§π‡§µ‡§æ‡§≤</h3>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; text-align:center;">
      <div style="background:#eee; padding:15px; border-radius:10px; grid-column: span 2;">
        <h1 id="dTotal" style="margin:0;">0</h1><small>‡§è‡§ï‡•Ç‡§£ ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä</small>
      </div>
      <div style="background:#d4edda; padding:15px; border-radius:10px;">
        <h1 id="dDone" style="color:green; margin:0;">0</h1><small>‚úÖ ‡§ö‡•á‡§ï ‡§ù‡§æ‡§≤‡•á</small>
      </div>
      <div style="background:#fff3cd; padding:15px; border-radius:10px;">
        <h1 id="dPlanning" style="color:#856404; margin:0;">0</h1><small>üóìÔ∏è ‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó</small>
      </div>
      <div style="background:#f8d7da; padding:15px; border-radius:10px; grid-column: span 2;">
        <h1 id="dPending" style="color:red; margin:0;">0</h1><small>‚ùå ‡§ï‡§æ‡§π‡•Ä‡§ö ‡§®‡§æ‡§π‡•Ä</small>
      </div>
    </div>
    <button class="action-btn" style="background:#666;" onclick="loadPeople()">Refresh Data üîÑ</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhg7nlZjHxOojoBZeBNIAjKhDwzXzr1io",
      authDomain: "swasth-80320.firebaseapp.com",
      projectId: "swasth-80320",
      storageBucket: "swasth-80320.firebasestorage.app",
      messagingSenderId: "143665591308",
      appId: "1:143665591308:web:99ce02ee034d041dd6ea29"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const loader = document.getElementById("loaderOverlay");
    function showLoading() { loader.style.display = "flex"; }
    function hideLoading() { loader.style.display = "none"; }

    window.openTab = function(id, btn){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab-btns button').forEach(b=>b.classList.remove('active-btn'));
      if(btn) btn.classList.add('active-btn');
    };

    /* --- CONTACT PICKER --- */
    window.pickContact = async function() {
      // Check if feature is supported (Mobile only)
      const supported = ('contacts' in navigator && 'ContactsManager' in window);
      
      if(supported) {
        try {
          const props = ['name', 'tel'];
          const opts = { multiple: false };
          const contacts = await navigator.contacts.select(props, opts);
          
          if(contacts.length > 0) {
            const c = contacts[0];
            
            // Fill Mobile
            if(c.tel && c.tel.length > 0) {
              document.getElementById("inpMobile").value = c.tel[0];
            }
            // Fill Name if empty
            if(c.name && c.name.length > 0) {
              const currentName = document.getElementById("inpName").value;
              if(!currentName) {
                 document.getElementById("inpName").value = c.name[0];
              }
            }
          }
        } catch(ex) {
          // Ignore error if user cancelled
          console.log(ex);
        }
      } else {
        alert("‡§π‡•á ‡§´‡•Ä‡§ö‡§∞ ‡§´‡§ï‡•ç‡§§ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ (Android/iOS) ‡§µ‡§∞ ‡§ö‡§æ‡§≤‡§§‡•á. ‡§≤‡•Ö‡§™‡§ü‡•â‡§™‡§µ‡§∞ ‡§®‡§Ç‡§¨‡§∞ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡§æ‡§µ‡§æ ‡§≤‡§æ‡§ó‡•á‡§≤.");
      }
    };

    /* --- BMI CALCULATOR --- */
    window.calcBMI = function() {
      let w = parseFloat(document.getElementById("inpWeight").value);
      let h = parseFloat(document.getElementById("inpHeight").value);
      let display = document.getElementById("bmiDisplay");
      
      if(w > 0 && h > 0) {
        let bmi = (w / ((h/100)*(h/100))).toFixed(1);
        let status = "";
        let color = "black";
        
        if(bmi < 18.5) { status = "Underweight"; color = "orange"; }
        else if(bmi < 25) { status = "Normal"; color = "green"; }
        else { status = "Overweight"; color = "red"; }
        
        display.innerHTML = `BMI: ${bmi} <span style="color:${color}">(${status})</span>`;
        display.dataset.val = bmi; 
        display.dataset.stat = status;
      } else {
        display.innerHTML = "BMI: 0.0";
      }
    };

    /* --- 1. SAVE --- */
    window.savePerson = async function(){
      const name = document.getElementById("inpName").value;
      const mobile = document.getElementById("inpMobile").value;
      const bmiVal = document.getElementById("bmiDisplay").dataset.val || "0";
      const bmiStat = document.getElementById("bmiDisplay").dataset.stat || "-";
      
      if(!name || !mobile) { alert("‡§®‡§æ‡§µ ‡§Ü‡§£‡§ø ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§≠‡§∞‡§æ!"); return; }
      showLoading();

      try {
        await addDoc(collection(db, "mission1lakh"), {
          name, mobile,
          age: document.getElementById("inpAge").value,
          weight: document.getElementById("inpWeight").value,
          height: document.getElementById("inpHeight").value,
          bmi: bmiVal,
          bmiStatus: bmiStat,
          status: "No",
          planDate: "", 
          regDate: new Date().toLocaleDateString('en-IN')
        });

        alert("‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•á! ‚úî");
        document.querySelectorAll("input").forEach(i => i.value = "");
        document.getElementById("bmiDisplay").innerHTML = "BMI: 0.0";
        loadPeople();
      } catch(e) { alert(e.message); }
      finally { hideLoading(); }
    };

    /* --- 2. LOAD & STATUS --- */
    window.loadPeople = async function(){
      showLoading();
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      
      let total=0, done=0, planning=0, pending=0;

      try {
        const snap = await getDocs(collection(db, "mission1lakh"));
        snap.forEach(d => {
          let p = d.data();
          let id = d.id;
          total++;
          
          if(p.status === "Yes") done++;
          else if(p.status === "Planning") planning++;
          else pending++;

          let rowClass = "row-pending";
          if(p.status === "Yes") rowClass = "row-done";
          if(p.status === "Planning") rowClass = "row-planning";

          let planDateInputStyle = (p.status === "Planning") ? "display:block;" : "display:none;";
          
          // WhatsApp Message Logic
          let msg = `‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞ ${p.name}, ‡§Æ‡§ø‡§∂‡§® 1 ‡§≤‡§æ‡§ñ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Ü‡§™‡§≤‡•á ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§.`;
          if(p.status === "Planning" && p.planDate) {
            msg = `‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞ ${p.name}, ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§§‡§™‡§æ‡§∏‡§£‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ${p.planDate} ‡§∞‡•ã‡§ú‡•Ä ‡§†‡§∞‡§≤‡•Ä ‡§Ü‡§π‡•á.`;
          } else if(p.status === "Yes") {
            msg = `‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞ ${p.name}, ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§§‡§Ø‡§æ‡§∞ ‡§Ü‡§π‡•á.`;
          }

          let waLink = `https://wa.me/91${p.mobile}?text=${encodeURIComponent(msg)}`;

          let row = tbody.insertRow();
          row.className = rowClass;
          
          row.innerHTML = `
            <td>
              <b>${p.name}</b><br>
              <small style="color:#555;">${p.mobile}</small><br>
              <small style="font-weight:bold;">BMI: ${p.bmi}</small>
            </td>
            <td>
              <select onchange="handleStatusChange('${id}', this)" class="status-select"
                 style="background:${p.status==='Yes'?'#d4edda':(p.status==='Planning'?'#fff3cd':'#fff')};">
                <option value="No" ${p.status==="No"?"selected":""}>‚ùå ‡§ö‡•á‡§ï ‡§®‡§æ‡§π‡•Ä</option>
                <option value="Planning" ${p.status==="Planning"?"selected":""}>üóìÔ∏è ‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó</option>
                <option value="Yes" ${p.status==="Yes"?"selected":""}>‚úÖ ‡§ù‡§æ‡§≤‡•á</option>
              </select>
              
              <input type="date" id="date_${id}" value="${p.planDate || ''}" 
                     style="${planDateInputStyle} width:100%; border:2px solid #ff9933; margin-top:5px;" 
                     onchange="updateDate('${id}', this.value)">
              <div id="dateDisplay_${id}" style="font-size:12px; color:#666; margin-top:2px; ${p.status==='Planning' && p.planDate ? 'display:block':'display:none'}">
                ‡§§‡§æ‡§∞‡•Ä‡§ñ: <b>${p.planDate}</b>
              </div>
            </td>
            <td>
              <a href="tel:${p.mobile}" class="btn-icon">üìû</a>
              <a href="${waLink}" target="_blank" class="btn-icon">üíö</a>
            </td>
            <td><button onclick="deletePerson('${id}')" style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px;">X</button></td>
          `;
        });

        document.getElementById("dTotal").innerText = total;
        document.getElementById("dDone").innerText = done;
        document.getElementById("dPlanning").innerText = planning;
        document.getElementById("dPending").innerText = pending;

      } catch(e) { console.error(e); }
      finally { hideLoading(); }
    };

    /* --- HANDLE STATUS CHANGE --- */
    window.handleStatusChange = async function(id, selectElem) {
      let val = selectElem.value;
      let dateInput = document.getElementById("date_"+id);
      
      if(val === "Planning") {
        dateInput.style.display = "block";
        dateInput.focus();
        await updateDoc(doc(db, "mission1lakh", id), { status: val });
      } 
      else {
        dateInput.style.display = "none";
        await updateDoc(doc(db, "mission1lakh", id), { status: val });
      }
      loadPeople();
    };

    window.updateDate = async function(id, dateVal) {
      if(dateVal) {
        showLoading();
        await updateDoc(doc(db, "mission1lakh", id), { planDate: dateVal });
        hideLoading();
        loadPeople();
      }
    };

    window.deletePerson = async function(id){
      if(confirm("‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•á?")) {
        await deleteDoc(doc(db, "mission1lakh", id));
        loadPeople();
      }
    };

    window.searchTable = function() {
      let input = document.getElementById("searchInput").value.toUpperCase();
      let tr = document.getElementById("dataTable").getElementsByTagName("tr");
      for (let i = 1; i < tr.length; i++) {
        let td = tr[i].getElementsByTagName("td")[0];
        if (td) tr[i].style.display = td.innerText.toUpperCase().indexOf(input) > -1 ? "" : "none";
      }
    };

    window.uploadReport = async function(){
      let file = document.getElementById("reportFile").files[0];
      if(!file) return alert("File ‡§®‡§ø‡§µ‡§°‡§æ");
      showLoading();
      try {
        await uploadBytes(ref(storage, "reports/" + file.name), file);
        alert("Uploaded ‚úî");
      } catch(e){ alert(e.message); } finally { hideLoading(); }
    };

    loadPeople();
  </script>
</body>
</html>
