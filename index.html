<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mission 1 Lakh - Final Report</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- GLOBAL STYLES --- */
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; 
      background: #f0f2f5; overflow-x: hidden; width: 100vw;
    }

    /* LOADER */
    #loaderOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #0057b7; border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* HEADER */
    .header { 
      background: linear-gradient(135deg, #0061f2 0%, #6900c7 100%); 
      padding: 25px 20px; text-align: center; color: white; 
      border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .header h2 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: 1px; }

    /* TABS */
    .tab-btns { display: flex; justify-content: center; gap: 8px; padding: 0 15px; margin-top: -20px; }
    .tab-btns button { 
      padding: 12px 10px; border: none; background: white; border-radius: 12px; 
      cursor: pointer; font-weight: bold; font-size: 13px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
      transition: 0.3s; color: #555; flex: 1; 
    }
    .tab-btns button.active-btn { 
      background: #ff9933; color: white; transform: translateY(-3px); 
      box-shadow: 0 6px 12px rgba(255, 153, 51, 0.4);
    }

    /* CONTAINER */
    .container { 
      width: 95%; max-width: 900px; margin: 20px auto; background: white; 
      padding: 20px; border-radius: 15px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); min-height: 500px;
    }
    .tab { display: none; }
    .active { display: block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* DASHBOARD */
    .dash-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
    .dash-card { padding: 20px; border-radius: 15px; color: white; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
    .card-total { background: linear-gradient(135deg, #667eea, #764ba2); }
    .card-done { background: linear-gradient(135deg, #42e695, #3bb2b8); }
    .card-plan { background: linear-gradient(135deg, #f6d365, #fda085); color: #444; }
    .card-pending { background: linear-gradient(135deg, #ff9a9e, #fecfef); color: #444; }
    .dash-num { font-size: 36px; font-weight: 800; display: block; }

    /* FORMS */
    label { display: block; margin-top: 15px; font-weight: 600; color: #444; font-size: 14px; }
    input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; font-size: 15px; }
    .action-btn { margin-top: 25px; background: #0061f2; color: white; padding: 15px; border: none; border-radius: 50px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }

    /* TABLE */
    .table-responsive { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 100%; }
    th { background: #f8f9fa; color: #444; padding: 12px 8px; font-size: 12px; text-align: left; border-bottom: 2px solid #eee; white-space: nowrap; }
    td { border-bottom: 1px solid #eee; padding: 12px 8px; vertical-align: middle; font-size: 14px; }
    .col-sr { width: 40px; text-align: center; color: #888; font-weight: bold; }

    /* EXPORT BUTTONS */
    .export-btns { display: flex; gap: 10px; margin-bottom: 15px; }
    .btn-export { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; font-size: 14px; }
    .btn-excel { background: #1D6F42; }
    .btn-pdf { background: #D32F2F; }

    /* UTILS */
    .pick-btn { background: #0061f2; color: white; border: none; border-radius: 8px; width: 50px; cursor: pointer; font-size: 20px; }
    .status-select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 100%; font-size: 13px; font-weight: 600; }
    
    /* STATUS BADGES FOR REPORT */
    .badge-done { background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 12px; }
    .badge-pending { background: #f8d7da; color: #721c24; padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 12px; }
    .badge-plan { background: #fff3cd; color: #856404; padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 12px; }

  </style>
</head>

<body>

  <div id="loaderOverlay"><div class="spinner"></div><p style="margin-top:10px; font-weight:bold; color:#0061f2;">Loading...</p></div>

  <div class="header">
    <h2>üáÆüá≥ Mission 1 Lakh</h2>
    <small>Swasthya Kranti 2026</small>
  </div>

  <div class="tab-btns">
    <button onclick="openTab('tab4', this)" class="active-btn">üìä Dashboard</button>
    <button onclick="openTab('tab1', this)">üìù ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä</button>
    <button onclick="openTab('tab2', this)">üóìÔ∏è ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏</button>
    <button onclick="openTab('tab3', this)">üìã ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</button>
  </div>

  <div id="tab4" class="tab active container" style="background:transparent; box-shadow:none; padding:0;">
    <div class="dash-grid">
      <div class="dash-card card-total"><span class="dash-num" id="dTotal">0</span><small>‡§è‡§ï‡•Ç‡§£ ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä</small></div>
      <div class="dash-card card-done"><span class="dash-num" id="dDone">0</span><small>‡§§‡§™‡§æ‡§∏‡§£‡•Ä ‡§ù‡§æ‡§≤‡•Ä</small></div>
      <div class="dash-card card-plan"><span class="dash-num" id="dPlanning">0</span><small>‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó (‡§ï‡§∞‡§£‡§æ‡§∞)</small></div>
      <div class="dash-card card-pending"><span class="dash-num" id="dPending">0</span><small>‡§¨‡§æ‡§ï‡•Ä (Pending)</small></div>
    </div>
    <button class="action-btn" onclick="loadPeople()" style="background:white; color:#333; margin-top:0;">üîÑ Refresh Data</button>
  </div>

  <div id="tab1" class="tab container">
    <h3>üìù ‡§®‡§µ‡•Ä‡§® ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä</h3>
    <label>‡§™‡•Ç‡§∞‡•ç‡§£ ‡§®‡§æ‡§µ</label>
    <input type="text" id="inpName" placeholder="‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ..."/>
    
    <div style="display:flex; gap:10px;">
      <div style="flex:1"><label>‡§µ‡§Ø</label><input type="number" id="inpAge" placeholder="30"/></div>
      <div style="flex:1">
          <label>‡§≤‡§ø‡§Ç‡§ó</label>
          <select id="inpGender">
              <option value="Male">‡§™‡•Å‡§∞‡•Å‡§∑</option>
              <option value="Female">‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä</option>
              <option value="Other">‡§á‡§§‡§∞</option>
          </select>
      </div>
    </div>

    <div style="margin-top:10px;">
        <label>‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤</label>
        <div style="display:flex; gap:5px;">
            <input type="tel" id="inpMobile" placeholder="Number"/>
            <button onclick="pickContact()" class="pick-btn">üìí</button>
        </div>
    </div>

    <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-top:20px; border:1px solid #eee;">
      <h4 style="margin:0 0 10px 0; color:#0061f2; font-size:14px;">‚öñÔ∏è BMI ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä (‡§µ‡§ú‡§®/‡§â‡§Ç‡§ö‡•Ä)</h4>
      <div style="display:flex; gap:10px;">
        <div style="flex:1"><input type="number" id="inpWeight" placeholder="‡§µ‡§ú‡§® (KG)" oninput="calcBMI()"/></div>
        <div style="flex:1"><input type="number" id="inpHeight" placeholder="‡§â‡§Ç‡§ö‡•Ä (CM)" oninput="calcBMI()"/></div>
      </div>
      <div id="bmiDisplay" style="margin-top:10px; font-weight:bold; font-size:14px; color:#444;">BMI: 0.0</div>
    </div>
    
    <button class="action-btn" onclick="savePerson()">üíæ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ</button>
  </div>

  <div id="tab2" class="tab container">
    <h3>üóìÔ∏è ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏ ‡§Ü‡§£‡§ø ‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó</h3>
    <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="üîç ‡§®‡§æ‡§µ‡§æ‡§®‡•á ‡§∂‡•ã‡§ß‡§æ..." style="padding:12px; width:100%; border-radius:25px; border:1px solid #ddd; margin-bottom:15px; outline:none;">
    
    <div class="table-responsive">
      <table id="dataTable">
        <thead>
          <tr>
            <th class="col-sr">‡§ï‡•ç‡§∞.</th>
            <th>‡§®‡§æ‡§µ / ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤</th>
            <th style="width:40%;">‡§∏‡•ç‡§ü‡•á‡§ü‡§∏ (‡§ï‡•É‡§§‡•Ä)</th>
            <th>Del</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab3" class="tab container">
    <h3>üìã ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§Ö‡§π‡§µ‡§æ‡§≤ (Report)</h3>
    <p>‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§æ‡§Ç‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§Ü‡§£‡§ø ‡§¨‡•ç‡§≤‡§° ‡§ö‡•á‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏.</p>
    
    <div class="export-btns">
      <button onclick="exportToExcel()" class="btn-export btn-excel">üìä Excel ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
      <button onclick="exportToPDF()" class="btn-export btn-pdf">üìÑ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
    </div>

    <div class="table-responsive">
      <table id="reportTable">
        <thead>
          <tr>
            <th class="col-sr">‡§ï‡•ç‡§∞.</th>
            <th>‡§®‡§æ‡§µ / ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä</th>
            <th>‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤</th>
            <th>‡§¨‡•ç‡§≤‡§° ‡§ö‡•á‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhg7nlZjHxOojoBZeBNIAjKhDwzXzr1io",
      authDomain: "swasth-80320.firebaseapp.com",
      projectId: "swasth-80320",
      storageBucket: "swasth-80320.firebasestorage.app",
      messagingSenderId: "143665591308",
      appId: "1:143665591308:web:99ce02ee034d041dd6ea29"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const loader = document.getElementById("loaderOverlay");
    function showLoading() { loader.style.display = "flex"; }
    function hideLoading() { loader.style.display = "none"; }

    window.openTab = function(id, btn){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab-btns button').forEach(b=>b.classList.remove('active-btn'));
      if(btn) btn.classList.add('active-btn');
      if(id === 'tab3') loadReportTab();
    };

    window.pickContact = async function() {
      if('contacts' in navigator) {
        try {
          const c = await navigator.contacts.select(['name', 'tel'], {multiple:false});
          if(c.length){
             if(c[0].tel) document.getElementById("inpMobile").value = c[0].tel[0].replace(/\s/g, '');
             if(c[0].name) document.getElementById("inpName").value = c[0].name[0];
          }
        } catch(e){}
      } else alert("Mobile Only Feature");
    };

    window.calcBMI = function() {
      let w = parseFloat(document.getElementById("inpWeight").value);
      let h = parseFloat(document.getElementById("inpHeight").value);
      let d = document.getElementById("bmiDisplay");
      if(w>0 && h>0) {
        let bmi = (w/((h/100)*(h/100))).toFixed(1);
        let s = bmi<18.5?"Underweight":bmi<25?"Normal":"Overweight";
        let c = bmi<18.5?"orange":bmi<25?"green":"red";
        d.innerHTML = `BMI: ${bmi} <span style="color:${c}">(${s})</span>`;
        d.dataset.val=bmi; d.dataset.stat=s;
      }
    };

    window.savePerson = async function(){
      const name = document.getElementById("inpName").value;
      const mobile = document.getElementById("inpMobile").value;
      const gender = document.getElementById("inpGender").value;
      const bmiVal = document.getElementById("bmiDisplay").dataset.val || "0";
      const bmiStat = document.getElementById("bmiDisplay").dataset.stat || "-";
      
      if(!name || !mobile) { alert("‡§®‡§æ‡§µ ‡§Ü‡§£‡§ø ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§≠‡§∞‡§æ!"); return; }
      showLoading();
      try {
        await addDoc(collection(db, "mission1lakh"), {
          name, mobile, gender,
          age: document.getElementById("inpAge").value,
          weight: document.getElementById("inpWeight").value,
          height: document.getElementById("inpHeight").value,
          bmi: bmiVal, bmiStatus: bmiStat,
          status: "No", planDate: "",
          regDate: new Date().toLocaleDateString('en-IN')
        });
        alert("‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•á! ‚úî");
        document.querySelectorAll("input").forEach(i => i.value = "");
        loadPeople();
      } catch(e) { alert(e.message); } finally { hideLoading(); }
    };

    window.loadPeople = async function(){
      showLoading();
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      let total=0, done=0, planning=0, pending=0;
      let srNo = 1;

      try {
        const snap = await getDocs(collection(db, "mission1lakh"));
        window.allPeople = [];
        snap.forEach(d => {
          let p = d.data(); p.id = d.id;
          window.allPeople.push(p);
          total++;
          if(p.status === "Yes") done++; 
          else if(p.status === "Planning") planning++; 
          else pending++;

          let row = tbody.insertRow();
          if(p.status === "Yes") row.style.background = "#e8f5e9";
          else if(p.status === "Planning") row.style.background = "#fff3cd";
          
          let planStyle = p.status==="Planning" ? "display:block" : "display:none";
          let waMsg = p.status==="Planning"?`‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ${p.planDate} ‡§†‡§∞‡§≤‡•Ä ‡§Ü‡§π‡•á.`:`‡§§‡•Å‡§Æ‡§ö‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§§‡§Ø‡§æ‡§∞ ‡§Ü‡§π‡•á.`;
          
          row.innerHTML = `
            <td class="col-sr">${srNo++}</td>
            <td>
              <b>${p.name}</b> <small>(${p.gender})</small><br>
              <small style="color:#666;">${p.mobile}</small>
              <div style="margin-top:5px;">
                 <a href="tel:${p.mobile}" style="font-size:18px; text-decoration:none; margin-right:10px;">üìû</a>
                 <a href="https://wa.me/91${p.mobile}?text=${encodeURIComponent(waMsg)}" target="_blank" style="font-size:18px; text-decoration:none;">üíö</a>
              </div>
            </td>
            <td>
              <select onchange="handleStatusChange('${p.id}', this)" class="status-select">
                <option value="No" ${p.status==="No"?"selected":""}>‚ùå ‡§ö‡•á‡§ï ‡§®‡§æ‡§π‡•Ä</option>
                <option value="Planning" ${p.status==="Planning"?"selected":""}>üóìÔ∏è ‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó</option>
                <option value="Yes" ${p.status==="Yes"?"selected":""}>‚úÖ ‡§ù‡§æ‡§≤‡•á</option>
              </select>
              <input type="date" id="date_${p.id}" value="${p.planDate||''}" style="${planStyle} width:100%; margin-top:5px; font-size:12px;" onchange="updateDate('${p.id}',this.value)">
              <div style="font-size:11px; margin-top:2px; color:#555; ${planStyle}">Date: ${p.planDate}</div>
            </td>
            <td><button onclick="deletePerson('${p.id}')" style="background:none; border:none; color:red; font-size:18px;">üóëÔ∏è</button></td>
          `;
        });
        document.getElementById("dTotal").innerText = total;
        document.getElementById("dDone").innerText = done;
        document.getElementById("dPlanning").innerText = planning;
        document.getElementById("dPending").innerText = pending;
      } catch(e){console.error(e);} finally { hideLoading(); }
    };

    window.handleStatusChange = async function(id, el) {
      await updateDoc(doc(db, "mission1lakh", id), { status: el.value });
      if(el.value==="Planning") document.getElementById("date_"+id).style.display="block";
      else document.getElementById("date_"+id).style.display="none";
    };
    
    window.updateDate = async(id,v) => await updateDoc(doc(db,"mission1lakh",id),{planDate:v});
    window.deletePerson = async(id) => {if(confirm("Delete?")){await deleteDoc(doc(db,"mission1lakh",id));loadPeople();}};

    // TAB 3: DATA REPORT (UPDATED)
    window.loadReportTab = function() {
      const tbody = document.querySelector("#reportTable tbody");
      tbody.innerHTML = "";
      let sr = 1;

      if(window.allPeople.length === 0) { tbody.innerHTML="<tr><td colspan='4' align='center'>‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä</td></tr>"; return; }

      window.allPeople.forEach(p => {
        let row = tbody.insertRow();
        
        // Status Badge Logic
        let statusBadge = "";
        if(p.status === "Yes") statusBadge = `<span class="badge-done">‚úÖ ‡§ù‡§æ‡§≤‡•á</span>`;
        else if(p.status === "Planning") statusBadge = `<span class="badge-plan">üóìÔ∏è ‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó</span>`;
        else statusBadge = `<span class="badge-pending">‚ùå ‡§®‡§æ‡§π‡•Ä</span>`;

        row.innerHTML = `
          <td class="col-sr">${sr++}</td>
          <td>
            <b>${p.name}</b> <br>
            <small style="color:#666;">${p.age} ‡§µ‡§∞‡•ç‡§∑‡•á / ${p.gender}</small><br>
            <small style="color:#0057b7;">BMI: ${p.bmi}</small>
          </td>
          <td style="font-weight:bold; color:#333;">${p.mobile}</td>
          <td>${statusBadge}</td>
        `;
      });
    };
    
    window.exportToExcel = function() {
      if(window.allPeople.length === 0) return alert("No Data");
      let data = window.allPeople.map(p => ({
        Name: p.name, Mobile: p.mobile, CheckStatus: p.status, 
        Gender: p.gender, Age: p.age, Weight: p.weight, Height: p.height, BMI: p.bmi
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "MissionData");
      XLSX.writeFile(wb, "Mission_1Lakh_Data.xlsx");
    };

    window.exportToPDF = function() {
      if(window.allPeople.length === 0) return alert("No Data");
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Mission 1 Lakh - Patient Report", 14, 20);
      let body = window.allPeople.map((p, i) => [i+1, p.name, p.mobile, p.status, p.bmi]);
      doc.autoTable({ head: [['Sr', 'Name', 'Mobile', 'Status', 'BMI']], body: body, startY: 30 });
      doc.save("Mission_Data.pdf");
    };

    window.searchTable = function() {
      let val = document.getElementById("searchInput").value.toUpperCase();
      let tr = document.getElementById("dataTable").getElementsByTagName("tr");
      for(let i=1; i<tr.length; i++){
        let td = tr[i].getElementsByTagName("td")[1];
        if(td) tr[i].style.display = td.innerText.toUpperCase().indexOf(val) > -1 ? "" : "none";
      }
    };

    loadPeople();
  </script>
</body>
</html>
