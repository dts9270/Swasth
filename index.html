<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mission 1 Lakh - Final Fixed</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* --- GLOBAL STYLES --- */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }

    /* HEADER */
    .header { 
      background: linear-gradient(135deg, #0061f2, #6900c7); 
      padding: 20px; text-align: center; color: white; 
      border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .header h2 { margin: 0; font-size: 22px; }

    /* TABS */
    .tab-btns { display: flex; justify-content: center; gap: 8px; padding: 15px; margin-top: -25px; }
    .tab-btns button { 
      padding: 10px; border: none; background: white; border-radius: 12px; 
      font-weight: bold; font-size: 13px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
      flex: 1; color: #555;
    }
    .tab-btns button.active-btn { background: #ff9933; color: white; transform: translateY(-3px); }

    /* CONTAINER */
    .container { 
      width: 95%; max-width: 800px; margin: 10px auto; background: white; 
      padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      min-height: 400px;
    }
    .tab { display: none; }
    .active { display: block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* DASHBOARD */
    .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .dash-card { padding: 15px; border-radius: 12px; color: white; text-align: center; }
    .card-total { background: linear-gradient(135deg, #667eea, #764ba2); }
    .card-done { background: #28a745; }
    .card-plan { background: #ffc107; color: #333; }
    .card-pending { background: #dc3545; }
    .dash-num { font-size: 28px; font-weight: bold; display: block; }

    /* FORMS */
    label { display: block; margin-top: 10px; font-weight: 600; color: #444; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; }
    .action-btn { margin-top: 20px; background: #0061f2; color: white; padding: 12px; border: none; border-radius: 50px; width: 100%; font-size: 16px; font-weight: bold; }

    /* TABLE - OLD COLOR CODING STYLE */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th { background: #0057b7; color: white; padding: 10px; text-align: left; }
    td { padding: 10px; border-bottom: 1px solid #ddd; vertical-align: middle; }
    
    /* Row Colors (As requested) */
    tr.row-done { background-color: #e8f5e9; }      /* Greenish */
    tr.row-planning { background-color: #fff3cd; }  /* Yellowish */
    tr.row-pending { background-color: #fff; }      /* White */

    /* UTILS */
    .status-select { padding: 5px; border-radius: 5px; width: 100%; font-weight: bold; }
    .bmi-text { font-weight: bold; font-size: 12px; }

  </style>
</head>

<body>

  <div class="header">
    <h2>ЁЯЗоЁЯЗ│ Mission 1 Lakh</h2>
    <small>Swasthya Kranti 2026</small>
  </div>

  <div class="tab-btns">
    <button onclick="openTab('tab4', this)" class="active-btn">ЁЯУК Dashboard</button>
    <button onclick="openTab('tab1', this)">ЁЯУЭ рдиреЛрдВрджрдгреА</button>
    <button onclick="openTab('tab2', this)">ЁЯЧУя╕П рд▓рд┐рд╕реНрдЯ</button>
    <button onclick="openTab('tab3', this)">ЁЯУЛ рд░рд┐рдкреЛрд░реНрдЯ</button>
  </div>

  <div id="tab4" class="tab active container">
    <div class="dash-grid">
      <div class="dash-card card-total"><span class="dash-num" id="dTotal">0</span><small>рдПрдХреВрдг</small></div>
      <div class="dash-card card-done"><span class="dash-num" id="dDone">0</span><small>рдЭрд╛рд▓реЗ</small></div>
      <div class="dash-card card-plan"><span class="dash-num" id="dPlanning">0</span><small>рдкреНрд▓реЕрдирд┐рдВрдЧ</small></div>
      <div class="dash-card card-pending"><span class="dash-num" id="dPending">0</span><small>рдмрд╛рдХреА</small></div>
    </div>
    <button class="action-btn" onclick="loadPeople()" style="background:white; color:#333; border:1px solid #ccc;">ЁЯФД Refresh Data</button>
  </div>

  <div id="tab1" class="tab container">
    <h3>ЁЯУЭ рдирд╡реАрди рдиреЛрдВрджрдгреА</h3>
    <label>рдкреВрд░реНрдг рдирд╛рд╡</label>
    <input type="text" id="inpName" placeholder="рдирд╛рд╡ рдЯрд╛рдХрд╛..."/>
    
    <div style="display:flex; gap:10px;">
      <div style="flex:1"><label>рд╡рдп</label><input type="number" id="inpAge" placeholder="30"/></div>
      <div style="flex:1">
          <label>рд▓рд┐рдВрдЧ</label>
          <select id="inpGender">
              <option value="Male">рдкреБрд░реБрд╖</option>
              <option value="Female">рд╕реНрддреНрд░реА</option>
              <option value="Other">рдЗрддрд░</option>
          </select>
      </div>
    </div>

    <div style="margin-top:10px;">
        <label>рдореЛрдмрд╛рдИрд▓</label>
        <div style="display:flex; gap:5px;">
            <input type="tel" id="inpMobile" placeholder="Number"/>
            <button onclick="pickContact()" style="background:#0061f2; color:white; border:none; border-radius:5px; width:50px;">ЁЯУТ</button>
        </div>
    </div>

    <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-top:20px; border:1px solid #eee;">
      <h4 style="margin:0; color:#0061f2;">тЪЦя╕П BMI (рд╡рдЬрди/рдЙрдВрдЪреА)</h4>
      <div style="display:flex; gap:10px; margin-top:5px;">
        <div style="flex:1"><input type="number" id="inpWeight" placeholder="рд╡рдЬрди (KG)" oninput="calcBMI()"/></div>
        <div style="flex:1"><input type="number" id="inpHeight" placeholder="рдЙрдВрдЪреА (CM)" oninput="calcBMI()"/></div>
      </div>
      <div id="bmiDisplay" style="margin-top:5px; font-weight:bold;">BMI: 0.0</div>
    </div>
    
    <button class="action-btn" onclick="savePerson()">ЁЯТ╛ рдорд╛рд╣рд┐рддреА рд╕реЗрд╡реНрд╣ рдХрд░рд╛</button>
  </div>

  <div id="tab2" class="tab container">
    <h3>ЁЯЧУя╕П рд▓рд┐рд╕реНрдЯ рдЖрдгрд┐ рдкреНрд▓реЕрдирд┐рдВрдЧ</h3>
    <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="ЁЯФН рдирд╛рд╡рд╛рдиреЗ рд╢реЛрдзрд╛..." style="width:100%; padding:10px; border-radius:20px; border:1px solid #ccc; margin-bottom:10px;">
    
    <div style="overflow-x:auto;">
      <table id="dataTable">
        <thead>
          <tr>
            <th>рдХреНрд░.</th>
            <th>рдирд╛рд╡ / BMI</th>
            <th style="width:40%;">рд╕реНрдЯреЗрдЯрд╕</th>
            <th>Del</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab3" class="tab container">
    <h3>ЁЯУЛ рдиреЛрдВрджрдгреА рдЕрд╣рд╡рд╛рд▓</h3>
    <div style="display:flex; gap:10px; margin-bottom:15px;">
      <button onclick="exportToExcel()" style="flex:1; padding:10px; background:#1D6F42; color:white; border:none; border-radius:5px;">ЁЯУК Excel</button>
      <button onclick="printPDF()" style="flex:1; padding:10px; background:#D32F2F; color:white; border:none; border-radius:5px;">ЁЯУД PDF Print</button>
    </div>

    <div style="overflow-x:auto;">
      <table id="reportTable">
        <thead>
          <tr>
            <th>рдХреНрд░.</th>
            <th>рдирд╛рд╡</th>
            <th>рдореЛрдмрд╛рдИрд▓</th>
            <th>рд╕реНрдЯреЗрдЯрд╕</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhg7nlZjHxOojoBZeBNIAjKhDwzXzr1io",
      authDomain: "swasth-80320.firebaseapp.com",
      projectId: "swasth-80320",
      storageBucket: "swasth-80320.firebasestorage.app",
      messagingSenderId: "143665591308",
      appId: "1:143665591308:web:99ce02ee034d041dd6ea29"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // TAB SWITCHER
    window.openTab = function(id, btn){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab-btns button').forEach(b=>b.classList.remove('active-btn'));
      if(btn) btn.classList.add('active-btn');
      if(id === 'tab3') loadReportTab();
    };

    // CONTACT PICKER
    window.pickContact = async function() {
      if('contacts' in navigator) {
        try {
          const c = await navigator.contacts.select(['name', 'tel'], {multiple:false});
          if(c.length){
             if(c[0].tel) document.getElementById("inpMobile").value = c[0].tel[0].replace(/\s/g, '');
             if(c[0].name) document.getElementById("inpName").value = c[0].name[0];
          }
        } catch(e){}
      } else alert("Mobile Only Feature");
    };

    // BMI CALCULATION
    window.calcBMI = function() {
      let w = parseFloat(document.getElementById("inpWeight").value);
      let h = parseFloat(document.getElementById("inpHeight").value);
      let d = document.getElementById("bmiDisplay");
      if(w>0 && h>0) {
        let bmi = (w/((h/100)*(h/100))).toFixed(1);
        let s = bmi<18.5?"Underweight":bmi<25?"Normal":"Overweight";
        let c = bmi<18.5?"orange":bmi<25?"green":"red";
        
        d.innerHTML = `BMI: ${bmi} <span style="color:${c}">(${s})</span>`;
        d.dataset.val=bmi; 
        d.dataset.stat=s; // Storing status for save
      }
    };

    // SAVE DATA
    window.savePerson = async function(){
      const name = document.getElementById("inpName").value;
      const mobile = document.getElementById("inpMobile").value;
      const gender = document.getElementById("inpGender").value;
      
      // Get BMI data from the display element
      const bmiVal = document.getElementById("bmiDisplay").dataset.val || "0";
      const bmiStat = document.getElementById("bmiDisplay").dataset.stat || "-";

      if(!name || !mobile) { alert("рдирд╛рд╡ рдЖрдгрд┐ рдореЛрдмрд╛рдИрд▓ рднрд░рд╛!"); return; }
      
      try {
        await addDoc(collection(db, "mission1lakh"), {
          name, mobile, gender,
          age: document.getElementById("inpAge").value,
          weight: document.getElementById("inpWeight").value,
          height: document.getElementById("inpHeight").value,
          bmi: bmiVal, 
          bmiStatus: bmiStat, // Saving the analysis (Normal/Overweight etc)
          status: "No", planDate: "",
          regDate: new Date().toLocaleDateString('en-IN')
        });
        alert("рд╕реЗрд╡реНрд╣ рдЭрд╛рд▓реЗ! тЬФ");
        document.getElementById("inpName").value = "";
        document.getElementById("inpMobile").value = "";
        loadPeople();
      } catch(e) { alert(e.message); }
    };

    // LOAD DATA
    window.loadPeople = async function(){
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      let total=0, done=0, planning=0, pending=0;
      let srNo = 1;

      try {
        const snap = await getDocs(collection(db, "mission1lakh"));
        window.allPeople = [];
        snap.forEach(d => {
          let p = d.data(); p.id = d.id;
          window.allPeople.push(p);
          
          if(p.status === "Yes") done++; 
          else if(p.status === "Planning") planning++; 
          else pending++;
          total++;

          let row = tbody.insertRow();
          
          // --- OLD COLOR CODING LOGIC ---
          if(p.status === "Yes") row.className = "row-done";
          else if(p.status === "Planning") row.className = "row-planning";
          else row.className = "row-pending";

          let planStyle = p.status==="Planning" ? "display:block" : "display:none";
          let msg = p.status==="Planning"?`рддреБрдордЪреА рддрд╛рд░реАрдЦ ${p.planDate} рдард░рд▓реА рдЖрд╣реЗ.`:`рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдЖрд╣реЗ.`;

          // BMI Color Logic for Display
          let bmiColor = "black";
          if(p.bmiStatus === "Underweight") bmiColor = "orange";
          else if(p.bmiStatus === "Normal") bmiColor = "green";
          else if(p.bmiStatus === "Overweight") bmiColor = "red";

          row.innerHTML = `
            <td>${srNo++}</td>
            <td>
              <b>${p.name}</b> <small>(${p.gender})</small><br>
              <small class="bmi-text" style="color:${bmiColor}">BMI: ${p.bmi} (${p.bmiStatus})</small><br>
              <div style="margin-top:4px;">
                <a href="tel:${p.mobile}" style="text-decoration:none;">ЁЯУЮ</a>
                <a href="https://wa.me/91${p.mobile}?text=${encodeURIComponent(msg)}" target="_blank" style="margin-left:8px; text-decoration:none;">ЁЯТЪ</a>
              </div>
            </td>
            <td>
              <select onchange="updateStatus('${p.id}', this)" class="status-select">
                <option value="No" ${p.status==="No"?"selected":""}>тЭМ рдирд╛рд╣реА</option>
                <option value="Planning" ${p.status==="Planning"?"selected":""}>ЁЯЧУя╕П рдкреНрд▓реЕрдирд┐рдВрдЧ</option>
                <option value="Yes" ${p.status==="Yes"?"selected":""}>тЬЕ рдЭрд╛рд▓реЗ</option>
              </select>
              <input type="date" id="date_${p.id}" value="${p.planDate||''}" style="${planStyle} width:100%; margin-top:5px;" onchange="updateDate('${p.id}',this.value)">
            </td>
            <td><button onclick="delP('${p.id}')" style="color:red; border:none; background:none; font-size:16px;">ЁЯЧСя╕П</button></td>
          `;
        });
        document.getElementById("dTotal").innerText = total;
        document.getElementById("dDone").innerText = done;
        document.getElementById("dPlanning").innerText = planning;
        document.getElementById("dPending").innerText = pending;
      } catch(e){console.error(e);}
    };

    window.updateStatus = async function(id, el) {
      await updateDoc(doc(db, "mission1lakh", id), { status: el.value });
      loadPeople(); // Reload to apply background color
    };
    window.updateDate = async(id,v) => await updateDoc(doc(db,"mission1lakh",id),{planDate:v});
    window.delP = async(id) => {if(confirm("Delete?")){await deleteDoc(doc(db,"mission1lakh",id));loadPeople();}};

    // REPORT TAB
    window.loadReportTab = function() {
      const tbody = document.querySelector("#reportTable tbody");
      tbody.innerHTML = "";
      let sr = 1;
      window.allPeople.forEach(p => {
        let statusText = p.status==="Yes" ? 'тЬЕ рдЭрд╛рд▓реЗ' : (p.status==="Planning" ? 'ЁЯЧУя╕П рдкреНрд▓реЕрдирд┐рдВрдЧ' : 'тЭМ рдирд╛рд╣реА');
        tbody.innerHTML += `<tr><td>${sr++}</td><td>${p.name} <br><small>${p.age}/${p.gender}</small></td><td>${p.mobile}</td><td>${statusText}</td></tr>`;
      });
    };

    // EXCEL
    window.exportToExcel = function() {
      let data = window.allPeople.map(p => ({Name:p.name, Mobile:p.mobile, Status:p.status, Age:p.age, Gender:p.gender, BMI:p.bmi, BMI_Analysis:p.bmiStatus}));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data");
      XLSX.writeFile(wb, "Mission_Data.xlsx");
    };

    // PDF PRINT (Window Print - Reliable)
    window.printPDF = function() {
      let printWindow = window.open('', '', 'height=600,width=800');
      let rows = window.allPeople.map((p,i) => `
        <tr>
          <td>${i+1}</td>
          <td>${p.name}</td>
          <td>${p.mobile}</td>
          <td>${p.bmi} (${p.bmiStatus})</td>
          <td>${p.status==='Yes'?'Done':(p.status==='Planning'?'Plan':'No')}</td>
        </tr>
      `).join('');

      printWindow.document.write(`<html><head><title>Report</title><style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:5px;text-align:left;}</style></head><body><h2>Mission Report</h2><table><thead><tr><th>Sr</th><th>Name</th><th>Mobile</th><th>BMI</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table></body></html>`);
      printWindow.document.close();
      printWindow.print();
    };

    window.searchTable = function() {
      let val = document.getElementById("searchInput").value.toUpperCase();
      let tr = document.getElementById("dataTable").getElementsByTagName("tr");
      for(let i=1; i<tr.length; i++){
        let td = tr[i].getElementsByTagName("td")[1];
        if(td) tr[i].style.display = td.innerText.toUpperCase().indexOf(val) > -1 ? "" : "none";
      }
    };

    loadPeople();
  </script>
</body>
</html>
