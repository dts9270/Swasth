<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mission 1 Lakh - Pro Dashboard</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* --- 1. GLOBAL & NO SCROLL SETTINGS --- */
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', sans-serif; 
      margin: 0; padding: 0; 
      background: #f4f7f6; 
      overflow-x: hidden; /* Stop Horizontal Scroll */
      width: 100vw;
    }

    /* LOADER */
    #loaderOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #0057b7; border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* HEADER */
    .header { 
      background: linear-gradient(135deg, #0057b7, #003366); 
      padding: 20px; text-align: center; color: white; 
      border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .header h2 { margin: 0; font-size: 22px; letter-spacing: 1px; }

    /* TABS */
    .tab-btns { 
      display: flex; justify-content: center; gap: 8px; 
      padding: 15px; margin-top: -15px;
    }
    .tab-btns button { 
      padding: 10px 12px; border: none; background: white; 
      border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 13px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s; color: #555;
      flex: 1; max-width: 100px;
    }
    .tab-btns button.active-btn { 
      background: #ff9933; color: white; transform: translateY(-2px); 
      box-shadow: 0 4px 10px rgba(255, 153, 51, 0.4);
    }

    /* CONTAINER */
    .container { 
      width: 96%; max-width: 800px; margin: 0 auto 20px auto; 
      background: white; padding: 15px; border-radius: 15px; 
      box-shadow: 0 5px 20px rgba(0,0,0,0.05); 
      min-height: 500px;
    }
    .tab { display: none; }
    .active { display: block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- 2. ATTRACTIVE DASHBOARD CARDS --- */
    .dash-grid {
      display: grid; 
      grid-template-columns: repeat(2, 1fr); /* 2 Columns */
      gap: 15px; margin-bottom: 20px;
    }
    .dash-card {
      padding: 20px; border-radius: 15px; color: white;
      text-align: center; position: relative; overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      transition: transform 0.2s;
    }
    .dash-card:active { transform: scale(0.98); }
    
    .card-total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-done { background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%); }
    .card-plan { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: #444; }
    .card-pending { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); color: #444; }

    .dash-num { font-size: 32px; font-weight: 800; display: block; margin-top: 5px; }
    .dash-label { font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; }
    .dash-icon { font-size: 24px; opacity: 0.8; }

    /* FORMS */
    label { display: block; margin-top: 12px; font-weight: 600; color: #444; font-size: 14px; }
    input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; background: #fafafa; }
    input:focus, select:focus { border-color: #0057b7; background: white; outline: none; }
    
    .action-btn { 
      margin-top: 25px; background: #0057b7; color: white; padding: 14px; 
      border: none; border-radius: 50px; cursor: pointer; width: 100%; 
      font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,87,183,0.3); 
    }

    /* TABLE STYLES (NO HORIZONTAL SCROLL) */
    .table-responsive { 
      width: 100%; overflow-x: auto; 
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; /* Fix layout */ }
    
    th { background: #f1f5f9; color: #444; padding: 10px 5px; font-size: 12px; text-align: left; }
    td { border-bottom: 1px solid #eee; padding: 10px 5px; vertical-align: middle; font-size: 13px; word-wrap: break-word; }
    
    /* Column Widths */
    .col-sr { width: 35px; text-align: center; font-weight: bold; color: #888; }
    .col-action { width: 40px; }

    /* STATUS COLORS */
    .status-select { padding: 6px; font-weight: bold; border-radius: 4px; border: 1px solid #ccc; width: 100%; font-size: 12px; }
    
    /* MODAL */
    #uploadModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }

    /* UTILS */
    .btn-icon { text-decoration: none; font-size: 20px; margin-right: 10px; }
    .pick-btn { background: #0057b7; color: white; border: none; border-radius: 5px; width: 45px; cursor: pointer; font-size: 18px; }

  </style>
</head>

<body>

  <div id="loaderOverlay"><div class="spinner"></div><p style="margin-top:10px; font-weight:bold; color:#0057b7;">Loading...</p></div>

  <div id="uploadModal">
    <div class="modal-content">
      <h3 style="color:#0057b7; margin-top:0;">üìÇ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ö‡§™‡§≤‡•ã‡§°</h3>
      <p id="modalUserName" style="color:#666; font-size:14px; margin-bottom:15px;"></p>
      <input type="file" id="popupFile" style="border: 2px dashed #ccc; padding: 10px; width:100%; margin-bottom:15px;">
      
      <div id="pContainer" style="width:100%; background:#eee; height:10px; border-radius:5px; display:none; overflow:hidden;">
        <div id="pBar" style="width:0%; height:100%; background:#28a745;"></div>
      </div>
      
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button onclick="closeModal()" style="flex:1; padding:10px; border:none; background:#eee; border-radius:5px;">Cancel</button>
        <button onclick="uploadFromModal()" style="flex:1; padding:10px; border:none; background:#0057b7; color:white; border-radius:5px;">Upload</button>
      </div>
      <input type="hidden" id="modalUserId">
    </div>
  </div>

  <div class="header">
    <h2>üáÆüá≥ Mission 1 Lakh</h2>
    <small>Swasthya Kranti 2026</small>
  </div>

  <div class="tab-btns">
    <button onclick="openTab('tab4', this)" class="active-btn">üìä Dashboard</button>
    <button onclick="openTab('tab1', this)">üìù ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä</button>
    <button onclick="openTab('tab2', this)">üóìÔ∏è ‡§Ø‡§æ‡§¶‡•Ä</button>
    <button onclick="openTab('tab3', this)">üìÇ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</button>
  </div>

  <div id="tab4" class="tab active container" style="background:transparent; box-shadow:none; padding:0;">
    <h3 style="margin-left:10px; color:#444;">‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§Ö‡§π‡§µ‡§æ‡§≤ (Live)</h3>
    
    <div class="dash-grid">
      <div class="dash-card card-total">
        <div class="dash-icon">üë•</div>
        <span class="dash-num" id="dTotal">0</span>
        <span class="dash-label">‡§è‡§ï‡•Ç‡§£ ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä</span>
      </div>
      <div class="dash-card card-done">
        <div class="dash-icon">‚úÖ</div>
        <span class="dash-num" id="dDone">0</span>
        <span class="dash-label">‡§ö‡•á‡§ï ‡§ù‡§æ‡§≤‡•á</span>
      </div>
      <div class="dash-card card-plan">
        <div class="dash-icon">üóìÔ∏è</div>
        <span class="dash-num" id="dPlanning">0</span>
        <span class="dash-label">‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó</span>
      </div>
      <div class="dash-card card-pending">
        <div class="dash-icon">‚è≥</div>
        <span class="dash-num" id="dPending">0</span>
        <span class="dash-label">‡§¨‡§æ‡§ï‡•Ä</span>
      </div>
    </div>

    <button class="action-btn" onclick="loadPeople()" style="background:white; color:#333; margin-top:0;">üîÑ Refresh Data</button>
  </div>

  <div id="tab1" class="tab container">
    <h3>üìù ‡§®‡§µ‡•Ä‡§® ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä</h3>
    <label>‡§™‡•Ç‡§∞‡•ç‡§£ ‡§®‡§æ‡§µ</label>
    <input type="text" id="inpName" placeholder="‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ..."/>
    
    <div style="display:flex; gap:10px;">
      <div style="flex:1"><label>‡§µ‡§Ø</label><input type="number" id="inpAge" placeholder="30"/></div>
      <div style="flex:1.5">
          <label>‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤</label>
          <div style="display:flex; gap:5px;">
            <input type="tel" id="inpMobile" placeholder="Number"/>
            <button onclick="pickContact()" class="pick-btn">üìí</button>
          </div>
      </div>
    </div>

    <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-top:15px; border:1px solid #eee;">
      <h4 style="margin:0 0 10px 0; color:#0057b7; font-size:14px;">‚öñÔ∏è BMI ‡§ï‡•Ö‡§≤‡•ç‡§ï‡•ç‡§Ø‡•Å‡§≤‡•á‡§ü‡§∞</h4>
      <div style="display:flex; gap:10px;">
        <div style="flex:1"><input type="number" id="inpWeight" placeholder="W (KG)" oninput="calcBMI()"/></div>
        <div style="flex:1"><input type="number" id="inpHeight" placeholder="H (CM)" oninput="calcBMI()"/></div>
      </div>
      <div id="bmiDisplay" style="margin-top:10px; font-weight:bold; font-size:13px;">BMI: 0.0</div>
    </div>
    
    <button class="action-btn" onclick="savePerson()">üíæ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ</button>
  </div>

  <div id="tab2" class="tab container">
    <h3>üóìÔ∏è ‡§Ø‡§æ‡§¶‡•Ä & ‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó</h3>
    <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="üîç ‡§®‡§æ‡§µ‡§æ‡§®‡•á ‡§∂‡•ã‡§ß‡§æ..." style="padding:12px; width:100%; border-radius:25px; border:1px solid #ddd; margin-bottom:15px; outline:none;">
    
    <div class="table-responsive">
      <table id="dataTable">
        <thead>
          <tr>
            <th class="col-sr">Sr.</th>
            <th>‡§®‡§æ‡§µ / BMI</th>
            <th style="width:35%;">‡§∏‡•ç‡§ü‡•á‡§ü‡§∏</th>
            <th class="col-action">Del</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="tab3" class="tab container">
    <h3>üìÇ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</h3>
    <div class="table-responsive">
      <table id="reportTable">
        <thead>
          <tr>
            <th class="col-sr">Sr.</th>
            <th>‡§®‡§æ‡§µ</th>
            <th>‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhg7nlZjHxOojoBZeBNIAjKhDwzXzr1io",
      authDomain: "swasth-80320.firebaseapp.com",
      projectId: "swasth-80320",
      storageBucket: "swasth-80320.firebasestorage.app",
      messagingSenderId: "143665591308",
      appId: "1:143665591308:web:99ce02ee034d041dd6ea29"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const loader = document.getElementById("loaderOverlay");
    function showLoading() { loader.style.display = "flex"; }
    function hideLoading() { loader.style.display = "none"; }

    window.openTab = function(id, btn){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab-btns button').forEach(b=>b.classList.remove('active-btn'));
      if(btn) btn.classList.add('active-btn');
      if(id === 'tab3') loadReportTab();
    };

    window.pickContact = async function() {
      if('contacts' in navigator) {
        try {
          const c = await navigator.contacts.select(['name', 'tel'], {multiple:false});
          if(c.length){
             if(c[0].tel) document.getElementById("inpMobile").value = c[0].tel[0].replace(/\s/g, '');
             if(c[0].name) document.getElementById("inpName").value = c[0].name[0];
          }
        } catch(e){}
      } else alert("Mobile Only Feature");
    };

    window.calcBMI = function() {
      let w = parseFloat(document.getElementById("inpWeight").value);
      let h = parseFloat(document.getElementById("inpHeight").value);
      let d = document.getElementById("bmiDisplay");
      if(w>0 && h>0) {
        let bmi = (w/((h/100)*(h/100))).toFixed(1);
        let s = bmi<18.5?"Underweight":bmi<25?"Normal":"Overweight";
        let c = bmi<18.5?"orange":bmi<25?"green":"red";
        d.innerHTML = `BMI: ${bmi} <span style="color:${c}">(${s})</span>`;
        d.dataset.val=bmi; 
      }
    };

    window.savePerson = async function(){
      const name = document.getElementById("inpName").value;
      const mobile = document.getElementById("inpMobile").value;
      const bmiVal = document.getElementById("bmiDisplay").dataset.val || "0";
      
      if(!name || !mobile) { alert("‡§®‡§æ‡§µ ‡§Ü‡§£‡§ø ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§≠‡§∞‡§æ!"); return; }
      showLoading();
      try {
        await addDoc(collection(db, "mission1lakh"), {
          name, mobile, 
          age: document.getElementById("inpAge").value,
          weight: document.getElementById("inpWeight").value,
          height: document.getElementById("inpHeight").value,
          bmi: bmiVal, 
          status: "No", planDate: "", reportUrl: "",
          regDate: new Date().toLocaleDateString('en-IN')
        });
        alert("‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•á! ‚úî");
        document.querySelectorAll("input").forEach(i => i.value = "");
        loadPeople();
      } catch(e) { alert(e.message); } finally { hideLoading(); }
    };

    window.loadPeople = async function(){
      showLoading();
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      let total=0, done=0, planning=0, pending=0;
      let srNo = 1; // SERIAL NUMBER

      try {
        const snap = await getDocs(collection(db, "mission1lakh"));
        window.allPeople = [];
        snap.forEach(d => {
          let p = d.data(); p.id = d.id;
          window.allPeople.push(p);
          total++;
          if(p.status === "Yes") done++; 
          else if(p.status === "Planning") planning++; 
          else pending++;

          let row = tbody.insertRow();
          // Status Color Logic
          if(p.status === "Yes") row.style.background = "#e8f5e9";
          else if(p.status === "Planning") row.style.background = "#fff3cd";
          
          let planStyle = p.status==="Planning" ? "display:block" : "display:none";
          let waMsg = p.status==="Planning"?`‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ${p.planDate} ‡§†‡§∞‡§≤‡•Ä ‡§Ü‡§π‡•á.`:`‡§§‡•Å‡§Æ‡§ö‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§§‡§Ø‡§æ‡§∞ ‡§Ü‡§π‡•á.`;
          
          row.innerHTML = `
            <td class="col-sr">${srNo++}</td>
            <td>
              <b>${p.name}</b><br>
              <small style="color:#666;">${p.mobile}</small>
              <div style="margin-top:5px;">
                 <a href="tel:${p.mobile}" class="btn-icon">üìû</a>
                 <a href="https://wa.me/91${p.mobile}?text=${encodeURIComponent(waMsg)}" target="_blank" class="btn-icon">üíö</a>
              </div>
            </td>
            <td>
              <select onchange="handleStatusChange('${p.id}', '${p.name}', this)" class="status-select">
                <option value="No" ${p.status==="No"?"selected":""}>‚ùå ‡§ö‡•á‡§ï ‡§®‡§æ‡§π‡•Ä</option>
                <option value="Planning" ${p.status==="Planning"?"selected":""}>üóìÔ∏è ‡§™‡•ç‡§≤‡•Ö‡§®‡§ø‡§Ç‡§ó</option>
                <option value="Yes" ${p.status==="Yes"?"selected":""}>‚úÖ ‡§ù‡§æ‡§≤‡•á</option>
              </select>
              <input type="date" id="date_${p.id}" value="${p.planDate||''}" style="${planStyle} width:100%; margin-top:5px; font-size:12px;" onchange="updateDate('${p.id}',this.value)">
              <div style="font-size:11px; margin-top:2px; color:#555; ${planStyle}">Date: ${p.planDate}</div>
            </td>
            <td><button onclick="deletePerson('${p.id}')" style="background:none; border:none; color:red; font-size:18px;">üóëÔ∏è</button></td>
          `;
        });
        document.getElementById("dTotal").innerText = total;
        document.getElementById("dDone").innerText = done;
        document.getElementById("dPlanning").innerText = planning;
        document.getElementById("dPending").innerText = pending;
      } catch(e){console.error(e);} finally { hideLoading(); }
    };

    window.handleStatusChange = async function(id, name, el) {
      await updateDoc(doc(db, "mission1lakh", id), { status: el.value });
      
      if(el.value==="Planning") document.getElementById("date_"+id).style.display="block";
      else if(el.value==="Yes") {
        document.getElementById("date_"+id).style.display="none";
        document.getElementById("uploadModal").style.display="flex";
        document.getElementById("modalUserName").innerText="Name: "+name;
        document.getElementById("modalUserId").value=id;
        document.getElementById("pContainer").style.display="none";
        document.getElementById("popupFile").value = "";
      } else document.getElementById("date_"+id).style.display="none";
    };
    
    window.closeModal = () => document.getElementById("uploadModal").style.display="none";
    
    window.uploadFromModal = function() {
      let file = document.getElementById("popupFile").files[0];
      let id = document.getElementById("modalUserId").value;
      if(!file) return alert("Select File");

      document.getElementById("pContainer").style.display="block";
      const task = uploadBytesResumable(ref(storage, "reports/"+file.name), file);
      
      task.on('state_changed', 
        (snap) => { document.getElementById("pBar").style.width = ((snap.bytesTransferred/snap.totalBytes)*100)+"%"; },
        (err) => alert(err.message),
        () => {
          getDownloadURL(task.snapshot.ref).then(async (url) => {
             await updateDoc(doc(db, "mission1lakh", id), { reportUrl: url });
             alert("Done ‚úî"); closeModal(); loadPeople();
          });
        }
      );
    };
    
    window.updateDate = async(id,v) => await updateDoc(doc(db,"mission1lakh",id),{planDate:v});
    window.deletePerson = async(id) => {if(confirm("Delete?")){await deleteDoc(doc(db,"mission1lakh",id));loadPeople();}};

    window.loadReportTab = function() {
      const tbody = document.querySelector("#reportTable tbody");
      tbody.innerHTML = "";
      let list = window.allPeople.filter(p => p.status === "Yes");
      let sr = 1;

      if(list.length === 0) { tbody.innerHTML="<tr><td colspan='3' align='center'>No Reports</td></tr>"; return; }

      list.forEach(p => {
        let row = tbody.insertRow();
        let btn = p.reportUrl 
          ? `<a href="${p.reportUrl}" target="_blank" style="color:blue; text-decoration:none; font-weight:bold;">üìÑ Download</a>` 
          : `<span style="color:red">Pending</span>`;

        row.innerHTML = `
          <td class="col-sr">${sr++}</td>
          <td><b>${p.name}</b></td>
          <td>${btn}</td>
        `;
      });
    };
    
    // Search Function
    window.searchTable = function() {
      let val = document.getElementById("searchInput").value.toUpperCase();
      let tr = document.getElementById("dataTable").getElementsByTagName("tr");
      for(let i=1; i<tr.length; i++){
        let td = tr[i].getElementsByTagName("td")[1]; // Name column
        if(td) tr[i].style.display = td.innerText.toUpperCase().indexOf(val) > -1 ? "" : "none";
      }
    };

    loadPeople();
  </script>
</body>
</html>
