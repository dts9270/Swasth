<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Advisor (Admin Pro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- 1. ‡§•‡•Ä‡§Æ ‡§Ü‡§£‡§ø ‡§≤‡•á‡§Ü‡§ä‡§ü (NO WHITE BG) --- */
        body {
            font-family: 'Segoe UI', 'Mukta', sans-serif; margin: 0; padding: 0;
            background: linear-gradient(180deg, rgba(255, 153, 51, 0.25) 0%, rgba(255, 255, 255, 0.9) 50%, rgba(19, 136, 8, 0.25) 100%);
            color: #222; min-height: 100vh;
        }
        .navbar {
            background: linear-gradient(90deg, #fff5e6, #fff, #e8f5e9);
            padding: 12px 25px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px solid #FF9933; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .logo { font-size: 1.5em; font-weight: 800; color: #000080; text-transform: uppercase; }
        .nav-btn {
            background: linear-gradient(90deg, #FF9933, #138808); color: white;
            border: none; padding: 8px 20px; border-radius: 20px; 
            cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ‡§ï‡§æ‡§∞‡•ç‡§° ‡§∏‡•ç‡§ü‡§æ‡§à‡§≤ */
        .container {
            max-width: 750px; margin: 30px auto;
            background: linear-gradient(180deg, #fffaf0 0%, #ffffff 60%, #f0fff4 100%);
            padding: 40px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-top: 8px solid #FF9933; border-bottom: 8px solid #138808;
            display: none;
        }
        .active-section { display: block; }

        /* ‡§π‡•á‡§°‡§∞‡•ç‡§∏ */
        h1 { 
            text-align: center; font-size: 1.8em; font-weight: 800;
            background: linear-gradient(to right, #d35400, #000080, #006400);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase;
        }
        h2 { 
            font-size: 1.2em; color: #000080; 
            background: linear-gradient(90deg, rgba(255,153,51,0.2), transparent);
            border-left: 6px solid #FF9933; padding: 10px; margin-top: 30px; margin-bottom: 15px; border-radius: 0 5px 5px 0;
        }

        /* ‡§á‡§®‡§™‡•Å‡§ü‡•ç‡§∏ */
        label { display: block; margin-top: 15px; font-weight: 700; color: #333; }
        input, select, textarea {
            width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #aaa; border-radius: 8px; font-size: 16px;
            background: linear-gradient(180deg, #fff8f0 0%, #fff 100%); transition: 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: #000080; background: #fff; }

        /* ‡§ö‡•á‡§ï‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ó‡•ç‡§∞‡§ø‡§° */
        .checkbox-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .checkbox-item {
            background: linear-gradient(90deg, #fffbf5, #f0fff4); border: 1px solid #ccc; padding: 10px 15px; 
            border-radius: 10px; font-size: 0.95em; cursor: pointer; display: flex; align-items: center;
        }
        .checkbox-item:hover { border-color: #138808; background: #e8f5e9; }
        .checkbox-item input { margin-right: 10px; transform: scale(1.3); }

        /* ‡§¨‡§ü‡§®‡•á */
        .btn-container { display: flex; gap: 15px; margin-top: 40px; border-top: 1px solid #bbb; padding-top: 20px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 50px; font-size: 1.1em; font-weight: bold; cursor: pointer; color: white; }
        .btn-submit { background: linear-gradient(45deg, #000080, #1a237e); }
        .btn-download { background: linear-gradient(90deg, #FF9933, #138808); }

        /* --- ADMIN ANALYSIS DASHBOARD --- */
        .analysis-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;
        }
        .stat-card {
            background: #fff; padding: 15px; border-radius: 10px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 4px solid #000080;
        }
        .stat-num { font-size: 1.8em; font-weight: bold; color: #000080; }
        .stat-label { font-size: 0.9em; color: #666; font-weight: bold; }
        
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        .admin-table th { background: linear-gradient(90deg, #FF9933, #FF9933); color: white; padding: 10px; text-align: left; }
        .admin-table td { border-bottom: 1px solid #ccc; padding: 10px; vertical-align: top; background: rgba(255,255,255,0.8); }

        /* Admin Action Buttons */
        .admin-actions { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-admin { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-excel { background: #217346; } /* Excel Green */
        .btn-pdf-sm { background: #d32f2f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
    </style>
</head>
<body>

<div class="navbar" data-html2canvas-ignore="true">
    <div class="logo">üáÆüá≥ RCM Health</div>
    <button class="nav-btn" onclick="window.showLogin()">‡•≤‡§°‡§Æ‡§ø‡§® ‡§™‡•Ö‡§®‡§≤</button>
</div>

<div class="container active-section" id="userPanel">
    <h1>‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø ‡§§‡§™‡§æ‡§∏‡§£‡•Ä ‡§´‡•â‡§∞‡•ç‡§Æ</h1>
    <p style="text-align:center; color:#444;">Online Health Audit</p>

    <form id="healthForm">
        <h2>‡•ß. ‡§µ‡•à‡§Ø‡§ï‡•ç‡§§‡§ø‡§ï ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä</h2>
        <label>‡§™‡•Ç‡§∞‡•ç‡§£ ‡§®‡§æ‡§µ:</label><input type="text" id="name" placeholder="‡§™‡•Ç‡§∞‡•ç‡§£ ‡§®‡§æ‡§µ">
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;"><label>‡§µ‡§Ø:</label><input type="number" id="age" placeholder="‡§µ‡§∞‡•ç‡§∑‡•á"></div>
            <div style="flex: 1;"><label>‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤:</label><input type="number" id="mobile" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤"></div>
        </div>
        <div style="display: flex; gap: 15px; margin-top:10px;">
            <div style="flex: 1;"><label>‡§â‡§Ç‡§ö‡•Ä (cm):</label><input type="number" id="height" placeholder="‡§â‡§¶‡§æ. 165"></div>
            <div style="flex: 1;"><label>‡§µ‡§ú‡§® (kg):</label><input type="number" id="weight" placeholder="‡§â‡§¶‡§æ. 65"></div>
        </div>

        <h2>‡•®. ‡§¶‡§ø‡§®‡§ö‡§∞‡•ç‡§Ø‡§æ</h2>
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;"><label>‡§â‡§†‡§£‡•á:</label><input type="time" id="wake"></div>
            <div style="flex: 1;"><label>‡§ù‡•ã‡§™‡§£‡•á:</label><input type="time" id="sleep"></div>
        </div>
        <label>‡§®‡§æ‡§∂‡•ç‡§§‡§æ:</label><textarea id="bf" rows="2" placeholder="‡§∏‡§ï‡§æ‡§≥‡•Ä ‡§ï‡§æ‡§Ø ‡§ñ‡§æ‡§§‡§æ?"></textarea>

        <h2>‡•©. ‡§Ü‡§π‡§æ‡§∞ ‡§Ü‡§£‡§ø ‡§§‡•á‡§≤</h2>
        <label>‡§∏‡•ç‡§µ‡§Ø‡§Ç‡§™‡§æ‡§ï‡§æ‡§ö‡•á ‡§§‡•á‡§≤:</label>
        <select id="oil">
            <option>-- ‡§®‡§ø‡§µ‡§°‡§æ --</option>
            <option>‡§∏‡•ã‡§Ø‡§æ‡§¨‡•Ä‡§® ‡§§‡•á‡§≤</option>
            <option>‡§∏‡•Ç‡§∞‡•ç‡§Ø‡§´‡•Ç‡§≤ ‡§§‡•á‡§≤</option>
            <option>‡§∞‡§æ‡§à‡§∏ ‡§¨‡•ç‡§∞‡§æ‡§® ‡§ë‡§á‡§≤ (Health Guard)</option>
            <option>‡§ò‡§æ‡§£‡•ç‡§Ø‡§æ‡§ö‡•á ‡§§‡•á‡§≤</option>
            <option>‡§á‡§§‡§∞</option>
        </select>
        <label>‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ:</label>
        <select id="exercise"><option>‡§®‡§æ‡§π‡•Ä</option><option>‡§π‡•ã, ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§</option><option>‡§ï‡§ß‡•Ä‡§§‡§∞‡•Ä</option></select>

        <h2>‡•™. ‡§∏‡§ß‡•ç‡§Ø‡§æ‡§ö‡•á ‡§Ü‡§ú‡§æ‡§∞</h2>
        <div class="checkbox-container">
            <label class="checkbox-item"><input type="checkbox" class="disease" value="BP"> ‡§¨‡•Ä‡§™‡•Ä (BP)</label>
            <label class="checkbox-item"><input type="checkbox" class="disease" value="Sugar"> ‡§∂‡•Å‡§ó‡§∞ (Diabetes)</label>
            <label class="checkbox-item"><input type="checkbox" class="disease" value="Thyroid"> ‡§•‡§æ‡§Ø‡§∞‡•â‡§à‡§°</label>
            <label class="checkbox-item"><input type="checkbox" class="disease" value="Acidity"> ‡•≤‡§∏‡§ø‡§°‡§ø‡§ü‡•Ä</label>
            <label class="checkbox-item"><input type="checkbox" class="disease" value="JointPain"> ‡§∏‡§æ‡§Ç‡§ß‡•á‡§¶‡•Å‡§ñ‡•Ä</label>
            <label class="checkbox-item"><input type="checkbox" class="disease" value="Fatigue"> ‡§•‡§ï‡§µ‡§æ</label>
        </div>

        <h2>‡•´. ‡§¨‡•ç‡§≤‡§° ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏</h2>
        <label>‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§¨‡•ç‡§≤‡§° ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡•á‡§≤‡•Ä ‡§Ü‡§π‡•á ‡§ï‡§æ?</label>
        <select id="bloodStatus" onchange="window.toggleReports()">
            <option value="No">‡§®‡§æ‡§π‡•Ä</option>
            <option value="Yes">‡§π‡•ã, ‡§ï‡•á‡§≤‡•Ä ‡§Ü‡§π‡•á</option>
        </select>

        <div id="reportSection" style="display: none; margin-top: 15px; border: 1px dashed #FF9933; padding: 15px; border-radius: 10px; background: rgba(255,255,255,0.5);">
            <label style="margin-top:0;">‡§ï‡•ã‡§£‡§§‡•á ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏?</label>
            <div class="checkbox-container">
                <label class="checkbox-item"><input type="checkbox" class="report" value="CBC"> CBC</label>
                <label class="checkbox-item"><input type="checkbox" class="report" value="Lipid Profile"> Lipid Profile</label>
                <label class="checkbox-item"><input type="checkbox" class="report" value="HbA1c"> HbA1c</label>
                <label class="checkbox-item"><input type="checkbox" class="report" value="Vitamin B12"> Vit B12</label>
                <label class="checkbox-item"><input type="checkbox" class="report" value="Vitamin D3"> Vit D3</label>
                <label class="checkbox-item"><input type="checkbox" class="report" value="Thyroid"> Thyroid</label>
                <label class="checkbox-item"><input type="checkbox" class="report" value="LFT/KFT"> LFT/KFT</label>
            </div>
        </div>

        <div class="btn-container" data-html2canvas-ignore="true">
            <button type="button" class="btn btn-submit" onclick="window.submitData()">‚úÖ Submit Data</button>
            <button type="button" class="btn btn-download" onclick="window.downloadPDF()">üìÑ Download PDF</button>
        </div>
    </form>
</div>

<div class="container" id="loginPanel" style="max-width:400px; text-align:center;">
    <h2>‡•≤‡§°‡§Æ‡§ø‡§® ‡§≤‡•â‡§ó‡§ø‡§®</h2>
    <input type="password" id="adminPass" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° (rcm)">
    <button class="btn btn-submit" style="margin-top:20px;" onclick="window.checkLogin()">‡§≤‡•â‡§ó‡§ø‡§®</button>
    <p style="margin-top:20px; cursor:pointer;" onclick="window.showUser()">‡§Æ‡§æ‡§ó‡•á ‡§ú‡§æ</p>
</div>

<div class="container" id="adminPanel" style="max-width:900px;">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #aaa; padding-bottom:15px; margin-bottom:20px;">
        <h2 style="margin:0; background:none; border:none; padding:0;">üìä Admin Analytics</h2>
        <button onclick="window.showUser()" style="background:red; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">Logout</button>
    </div>

    <div class="analysis-grid">
        <div class="stat-card">
            <div class="stat-num" id="totalCount">0</div>
            <div class="stat-label">‡§è‡§ï‡•Ç‡§£ ‡§∞‡•Å‡§ó‡•ç‡§£ (Total)</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="bpCount" style="color:#d32f2f;">0</div>
            <div class="stat-label">BP / Sugar ‡§∞‡•Å‡§ó‡•ç‡§£</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="oilCount" style="color:#FF9933;">0</div>
            <div class="stat-label">‡§á‡§§‡§∞ ‡§§‡•á‡§≤ ‡§µ‡§æ‡§™‡§∞‡§£‡§æ‡§∞‡•á</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="fitCount" style="color:#138808;">0</div>
            <div class="stat-label">Fit ‡§∞‡•Å‡§ó‡•ç‡§£ (BMI)</div>
        </div>
    </div>

    <div class="admin-actions">
        <button class="btn-admin btn-excel" onclick="window.exportToExcel()">üì• Excel Download</button>
        </div>

    <div style="overflow-x:auto;">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                    <th>‡§®‡§æ‡§µ & ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤</th>
                    <th>‡§Ü‡§ú‡§æ‡§∞ & BMI</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="hiddenPdfTemplate" style="display:none; padding:20px; font-family:sans-serif;">
    <h1 style="color:#000080;">RCM Health Report</h1>
    <p><strong>Name:</strong> <span id="pdfName"></span></p>
    <p><strong>Mobile:</strong> <span id="pdfMobile"></span></p>
    <p><strong>BMI Status:</strong> <span id="pdfBmi"></span></p>
    <p><strong>Diseases:</strong> <span id="pdfDisease"></span></p>
    <p><strong>Reports:</strong> <span id="pdfReport"></span></p>
    <p><strong>Oil Used:</strong> <span id="pdfOil"></span></p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhg7nlZjHxOojoBZeBNIAjKhDwzXzr1io",
      authDomain: "swasth-80320.firebaseapp.com",
      projectId: "swasth-80320",
      storageBucket: "swasth-80320.firebasestorage.app",
      messagingSenderId: "143665591308",
      appId: "1:143665591308:web:51b7ef03156b10fed6ea29"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const reportsCol = collection(db, 'health_reports');

    let allReportsData = []; // To store data for Excel/Analysis

    // --- NAVIGATION ---
    window.showUser = () => {
        document.getElementById('userPanel').style.display = 'block';
        document.getElementById('loginPanel').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
    }
    window.showLogin = () => {
        document.getElementById('userPanel').style.display = 'none';
        document.getElementById('loginPanel').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none';
    }
    window.toggleReports = () => {
        let status = document.getElementById('bloodStatus').value;
        document.getElementById('reportSection').style.display = (status === 'Yes') ? 'block' : 'none';
    }

    // --- SUBMIT ---
    window.submitData = async () => {
        let name = document.getElementById('name').value;
        if(!name) { alert("‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ."); return; }

        let h = document.getElementById('height').value;
        let w = document.getElementById('weight').value;
        let bmiRes = "N/A";
        let isFit = false;
        if(h && w) {
            let m = h/100;
            let val = (w/(m*m)).toFixed(1);
            let st = (val<18.5)?"(Low)":(val<25)?"(Fit)":"(High)";
            bmiRes = `${val} ${st}`;
            if(val >= 18.5 && val < 25) isFit = true;
        }

        let diseases = [];
        document.querySelectorAll('.disease:checked').forEach(d => diseases.push(d.value));
        
        let reports = [];
        if(document.getElementById('bloodStatus').value === 'Yes') {
            document.querySelectorAll('.report:checked').forEach(r => reports.push(r.value));
        } else { reports.push("‡§ï‡•á‡§≤‡•Ä ‡§®‡§æ‡§π‡•Ä"); }

        try {
            await addDoc(reportsCol, {
                date: new Date().toLocaleDateString('mr-IN'),
                name: name,
                mobile: document.getElementById('mobile').value,
                age: document.getElementById('age').value,
                height: h, weight: w, bmi: bmiRes, isFit: isFit,
                oil: document.getElementById('oil').value,
                disease: diseases.join(', ') || '‡§®‡§ø‡§∞‡•ã‡§ó‡•Ä',
                report: reports.join(', '),
                timestamp: Date.now()
            });
            alert("‚úÖ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä Online ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•Ä!");
            document.getElementById('healthForm').reset();
            window.toggleReports();
        } catch (e) { alert("Error: " + e.message); }
    }

    // --- ADMIN LOGIC ---
    window.checkLogin = () => {
        if(document.getElementById('adminPass').value === "rcm") {
            document.getElementById('loginPanel').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            window.loadAdminData();
        } else alert("Error");
    }

    window.loadAdminData = () => {
        onSnapshot(reportsCol, (snapshot) => {
            let tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            allReportsData = [];
            
            // Analytics Counters
            let total = 0, bpSugar = 0, otherOil = 0, fit = 0;

            snapshot.forEach((doc) => {
                let i = doc.data();
                i.id = doc.id; // Store ID
                allReportsData.push(i);

                // Stats Calculation
                total++;
                if(i.disease.includes('BP') || i.disease.includes('Sugar')) bpSugar++;
                if(i.isFit) fit++;
                if(!i.oil.includes('Rice Bran') && !i.oil.includes('Health Guard')) otherOil++;

                tbody.innerHTML += `<tr>
                    <td>${i.date}</td>
                    <td><b>${i.name}</b><br>${i.mobile}</td>
                    <td>${i.bmi}<br><span style="color:red; font-size:0.8em">${i.disease}</span></td>
                    <td>
                        <button class="btn-pdf-sm" onclick="window.genAdminPDF('${i.id}')">üìÑ PDF</button>
                        <button onclick="window.deleteRec('${i.id}')" style="color:red;border:none;background:none;font-size:1.2em;cursor:pointer;">&times;</button>
                    </td>
                </tr>`;
            });

            // Update UI
            document.getElementById('totalCount').innerText = total;
            document.getElementById('bpCount').innerText = bpSugar;
            document.getElementById('oilCount').innerText = otherOil;
            document.getElementById('fitCount').innerText = fit;
        });
    }

    // --- EXCEL EXPORT ---
    window.exportToExcel = () => {
        if(allReportsData.length === 0) { alert("Data not available"); return; }
        let csv = "Date,Name,Age,Mobile,BMI,Oil,Disease,Reports\n";
        allReportsData.forEach(r => {
            csv += `${r.date},${r.name},${r.age},${r.mobile},${r.bmi},${r.oil},"${r.disease}","${r.report}"\n`;
        });
        let a = document.createElement("a");
        a.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
        a.download = "RCM_All_Data.csv";
        a.click();
    }

    // --- ADMIN INDIVIDUAL PDF ---
    window.genAdminPDF = (id) => {
        let rec = allReportsData.find(r => r.id === id);
        if(!rec) return;

        // Fill hidden template
        document.getElementById('pdfName').innerText = rec.name;
        document.getElementById('pdfMobile').innerText = rec.mobile;
        document.getElementById('pdfBmi').innerText = rec.bmi;
        document.getElementById('pdfDisease').innerText = rec.disease;
        document.getElementById('pdfReport').innerText = rec.report;
        document.getElementById('pdfOil').innerText = rec.oil;

        let el = document.getElementById('hiddenPdfTemplate');
        el.style.display = 'block'; // Temporarily show
        html2pdf().from(el).save(`Report_${rec.name}.pdf`).then(() => {
            el.style.display = 'none'; // Hide again
        });
    }

    window.deleteRec = async (id) => {
        if(confirm("Delete this record?")) {
            await deleteDoc(doc(db, "health_reports", id));
        }
    }

    window.downloadPDF = () => {
        html2pdf().from(document.getElementById('userPanel')).save();
    }

    window.showUser(); // Init
</script>

</body>
</html>
